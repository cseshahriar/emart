# ==========================================
# Continuous Deployment for Django (Release)
# create, variables on repository and add server host, user, and public ket and
# cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
# ssh key is private key
# git push release
#    â†“
# GitHub Actions CD
#    â†“
# SSH â†’ /emart
#    â†“
# git pull
#    â†“
# migrate â†’ check â†’ collectstatic
#    â†“
# restart gunicorn â†’ restart nginx
# ==========================================
name: Django CD (Release Deploy)

on:
  push:
    branches:
      - release

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 300s
          script: |
            set -e

            echo "ğŸš€ Deploying RELEASE branch"

            # Go to project directory
            cd ~/emart

            echo "ğŸ“¥ Pull latest code"
            git pull origin release

            echo "ğŸ Activate virtualenv"
            source venv/bin/activate

            echo "ğŸ“¦ Install dependencies"
            pip install -r requirements/production.txt

            echo "ğŸ§± Apply migrations"
            python manage.py migrate --noinput

            echo "ğŸ” Django production check"
            python manage.py check --deploy

            echo "ğŸ¨ Collect static files"
            python manage.py collectstatic --noinput

            echo "ğŸ”„ Restart Gunicorn (only if all above succeeded)"
            sudo systemctl restart gunicorn

            echo "ğŸŒ Restart Nginx"
            sudo systemctl restart nginx

            echo "âœ… Release deployment successful"
