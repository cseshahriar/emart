# Build, Test, and Push

# ==========================================
# Workflow name (GitHub Actions UI তে দেখা যাবে)
# ==========================================
name: Django CI # Name of the workflow

# ==========================================
# কখন এই workflow রান করবে, Run on push to dev,
#  main, release or PR targeting them
# ==========================================
on:
  # main, dev, release ব্রাঞ্চে push হলে রান করবে
  push:
    branches: [main, release]

  # main, dev, release ব্রাঞ্চে PR গেলে রান করবে
  pull_request:
    branches: [main, release]

# ==========================================
# Workflow এর সব job এখানে define হয়
# ==========================================
jobs:
  # Job name: test
  test:
    # GitHub-hosted runner (Ubuntu latest)
    runs-on: ubuntu-latest # CI environment

    # ----------------------------------------
    # Environment variables (job-level)
    # Django settings থেকে DB config পড়ার জন্য
    # ----------------------------------------
    env:
      DB_NAME: test_db
      DB_USER: postgres
      DB_PASS: postgres
      DB_HOST: 127.0.0.1
      DB_PORT: 5432

    # ========================================
    # External services (Docker containers)
    # এখানে PostgreSQL চালু হবে
    # ========================================

    services:
      postgres:
        image: postgres:15 # PostgreSQL Docker image

        # Container এর ভিতরের environment
        env:
          POSTGRES_DB: test_db # DB name for CI
          POSTGRES_USER: postgres # DB user
          POSTGRES_PASSWORD: postgres # DB password

        # Host → Container port mapping
        ports:
          - 5432:5432

        # Health check: DB ready কিনা যাচাই
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    # ========================================
    # Job এর ধাপে ধাপে কাজ
    # ========================================
    steps:
      # Step
      # --------------------------------------
      # Step 1: Repository code checkout
      # --------------------------------------
      - uses: actions/checkout@v4

      # 2Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/local.txt

      # Step 4: Run code format check with black
      - name: Check code format with Black
        run: black --check .

      # Step 5: Run Lint code with Flake8
      - name: Lint code with Flake8
        run: flake8

      # Step 6: Run test with coverage
      - name: Run pytest with coverage
        env:
          DB_NAME: test_db
          DB_USER: postgres
          DB_PASS: postgres
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
        run: |
          pytest --cov=.


      # Step 7: Run migrations to prepare DB
      - name: Run migrations
        env: # Set DB environment variables for Django
          DB_NAME: test_db
          DB_USER: postgres
          DB_PASS: postgres
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
        run: |
          python manage.py migrate

      # Step 8: Run django db tests
      - name: Run Django tests
        env: # DB env again for test run
          DB_NAME: test_db
          DB_USER: postgres
          DB_PASS: postgres
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
        run: |
          python manage.py test --keepdb --noinput

      # Step 9: Optional: Cache pip packages for faster runs
      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements/base.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
