# ==========================================
# Django CI/CD - Test and Deploy (Release Branch Only)
# ==========================================
name: Django CI/CD (Release)

on:
    push:
        branches: [release]

jobs:
    # ==========================================
    # JOB 1: Run Tests
    # ==========================================
    test:
        name: Run Tests
        runs-on: ubuntu-latest

        env:
            DB_NAME: test_db
            DB_USER: postgres
            DB_PASS: postgres
            DB_HOST: 127.0.0.1
            DB_PORT: 5432

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_DB: test_db
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Cache pip packages
              uses: actions/cache@v3
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements/local.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements/local.txt

            - name: Check code format with Black
              run: black --check .

            - name: Lint code with Flake8
              run: flake8

            - name: Run pytest with coverage
              run: pytest --cov=.

            - name: Run migrations
              run: python manage.py migrate

            - name: Run Django tests
              run: python manage.py test --keepdb --noinput

    # ==========================================
    # JOB 2: Deploy to Production
    # Only runs if test job succeeds
    # ==========================================
    deploy:
        name: Deploy to Production
        needs: test
        runs-on: ubuntu-latest

        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_KEY }}
                  timeout: 300s
                  script: |
                      set -e

                      echo "ğŸš€ Deploying RELEASE branch"

                      cd ~/emart

                      echo "ğŸ“¥ Pull latest code from release"
                      git pull origin release

                      echo "ğŸ Activate virtual environment"
                      source venv/bin/activate

                      echo "ğŸ“¦ Install/update dependencies"
                      pip install -r requirements/prod.txt

                      echo "ğŸ§± Apply database migrations"
                      python manage.py migrate --noinput

                      echo "ğŸŒ Compile translation messages"
                      python manage.py compilemessages

                      echo "ğŸ” Run Django production checks"
                      python manage.py check --deploy

                      echo "ğŸ¨ Collect static files"
                      python manage.py collectstatic --noinput

                      echo "ğŸ”„ Restart Gunicorn service"
                      sudo systemctl restart gunicorn

                      echo "ğŸŒ Restart Nginx service"
                      sudo systemctl restart nginx

                      echo "âœ… Deployment completed successfully!"
